<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DZMM | å¤§å®¶éƒ½çˆ±ç©</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css"/>
    <script src="https://fastly.jsdelivr.net/npm/vue@3"></script>
    <script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>
    <style>
        [v-cloak] {
            display: none;
        }

        :root {
            --tg-theme-bg-color: #1a1a1a;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #ff69b4;
            --tg-theme-button-color: #ff69b4;
            --tg-theme-button-text-color: #ffffff;
            --card-bg-color: #2a2a2a;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .app-container {
            padding-bottom: 50px;
        }

        .nav-bar {
            background-color: var(--card-bg-color) !important;
        }

        .card {
            background: var(--card-bg-color);
            border-radius: 12px;
            margin: 12px;
            overflow: hidden;
        }

        .card-cover {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .card-content {
            padding: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .card-desc {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin-bottom: 8px;
        }

        .card-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: var(--tg-theme-hint-color);
        }

        .rating {
            color: #ff9800;
        }

        .heat {
            color: #f44336;
        }

        .author {
            color: var(--tg-theme-link-color);
        }

        .search-bar {
            padding: 8px 12px;
            background: var(--card-bg-color);
        }

        .tab-content {
            min-height: calc(100vh - 96px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card-grid" id="cardGrid"></div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modalTitle"></h2>
            <img id="modalImage" style="max-width: 100%; border-radius: 8px;">
            <p id="modalDescription"></p>
            <div id="modalStats"></div>
            <button class="button" id="startChat">å¼€å§‹å¯¹è¯</button>
        </div>
    </div>

    <script>
        let webapp = window.Telegram.WebApp;
        webapp.ready();
        
        let selectedCard = null;

        // åŠ è½½è§’è‰²æ•°æ®
        async function loadCards() {
            try {
                const response = await fetch('https://api.github.com/repos/lvwwi/telegram-roleplay-webapp/issues?labels=card&state=open');
                const issues = await response.json();
                
                const cardGrid = document.getElementById('cardGrid');
                cardGrid.innerHTML = '';
                
                issues.forEach(issue => {
                    try {
                        const cardData = parseCardFromIssue(issue);
                        if (cardData) {
                            const card = createCardElement(cardData);
                            cardGrid.appendChild(card);
                        }
                    } catch (e) {
                        console.error('Error parsing card:', e);
                    }
                });
            } catch (e) {
                console.error('Error loading cards:', e);
                webapp.showAlert('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
            }
        }

        // ä» Issue è§£æå¡ç‰‡æ•°æ®
        function parseCardFromIssue(issue) {
            const body = issue.body;
            if (!body.includes('```json')) return null;
            
            const jsonStr = body.split('```json')[1].split('```')[0].trim();
            const cardData = JSON.parse(jsonStr);
            
            // æå–å›¾ç‰‡ URL
            let imageUrl = null;
            const lines = body.split('\n');
            for (const line of lines) {
                if (line.includes('![') && line.includes('](') && line.includes(')')) {
                    imageUrl = line.split('](')[1].split(')')[0];
                    break;
                }
            }
            
            return {
                id: issue.number,
                title: cardData.title,
                description: cardData.description,
                image_url: imageUrl || 'https://via.placeholder.com/300',
                personality: cardData.personality,
                cost: cardData.cost || 0,
                rating: cardData.rating || 5.0,
                heat: cardData.heat || 0,
                interactions: cardData.interactions || {
                    "æŠ±æŠ±": "æ¸©æŸ”åœ°ä¾ååœ¨ä½ æ€€é‡Œ",
                    "äº²äº²": "è½»è½»åœ°åœ¨ä½ å”‡ä¸Šç•™ä¸‹ä¸€å»",
                    "æ‘¸å¤´": "å¹¸ç¦åœ°çœ¯èµ·çœ¼ç›",
                    "è°ƒæƒ…": "å®³ç¾åœ°é è¿‘ä½ "
                }
            };
        }

        // åˆ›å»ºå¡ç‰‡å…ƒç´ 
        function createCardElement(card) {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <img class="card-image" src="${card.image_url}" alt="${card.title}">
                <div class="card-content">
                    <h3 class="card-title">${card.title}</h3>
                    <p class="card-subtitle">${card.personality}</p>
                    <div class="card-stats">
                        <span>â­ ${card.rating}</span>
                        <span>ğŸ”¥ ${card.heat}</span>
                        <span>ğŸ’ ${card.cost}</span>
                    </div>
                </div>
            `;
            
            div.onclick = () => showCardDetail(card);
            return div;
        }

        // æ˜¾ç¤ºè§’è‰²è¯¦æƒ…
        function showCardDetail(card) {
            selectedCard = card;
            
            document.getElementById('modalTitle').textContent = card.title;
            document.getElementById('modalImage').src = card.image_url;
            document.getElementById('modalDescription').textContent = card.description;
            
            const statsHtml = `
                <p>ğŸ­ æ€§æ ¼ï¼š${card.personality}</p>
                <p>â­ è¯„åˆ†ï¼š${card.rating}</p>
                <p>ğŸ”¥ çƒ­åº¦ï¼š${card.heat}</p>
                <p>ğŸ’ èŠ±è´¹ï¼š${card.cost} ç§¯åˆ†</p>
                <p>ğŸ’« äº’åŠ¨ï¼š${Object.keys(card.interactions).join('ã€')}</p>
            `;
            document.getElementById('modalStats').innerHTML = statsHtml;
            
            const modal = document.getElementById('modal');
            modal.style.display = 'flex';
        }

        // ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¼¹çª—
        document.getElementById('modal').onclick = function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        };

        // å¼€å§‹å¯¹è¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('startChat').onclick = function() {
            if (!selectedCard) return;
            
            webapp.sendData(JSON.stringify({
                action: 'select_role',
                roleId: selectedCard.id
            }));
            
            webapp.close();
        };

        // åŠ è½½è§’è‰²åˆ—è¡¨
        loadCards();

        // è®¾ç½®ä¸»é¢˜é¢œè‰²
        webapp.setHeaderColor(webapp.themeParams.bg_color);
        webapp.expand();
    </script>
</body>
</html>